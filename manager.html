<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å“é …åˆ—è¡¨</title>
  <!-- Bootstrap & Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  
  <!-- DataTables + Bootstrap 5 -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<style>
  .truncate {
    max-width: 150px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #loadingMask {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border: 6px solid #f3f3f3;
    border-top: 6px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0%   { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
<script>
  window.onload = async () => {
    await liff.init({ liffId: "2007457926-5wAYNP0w" });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    // console.log("âœ… userId:", profile.userId);
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("createOrder").disabled = false;
  }
</script>
<body>

  <div class="container mt-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">å“é …åˆ—è¡¨</h5>
        <a href="#" class="link-primary" onclick="addGroupBuyModal()">
          <i class="fas fa-plus"></i> æ–°å¢
        </a>
      </div>
      <div class="card-body">
        <table id="example" class="table table-striped table-hover table-bordered w-100">
          <thead>
            <tr>
              <th>åç¨±</th>
              <th>ç‹€æ…‹</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="loadingMask"><div class="spinner"></div></div>

  <!-- æ–°å¢ Modal è¡¨å–® -->
  <div class="modal fade" id="groupBuyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æ–°å¢åœ˜è³¼é …ç›®</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Tabs -->
          <ul class="nav nav-tabs mb-3" id="Tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">æ–°å¢åœ˜è³¼å“é …</button>
            </li>
<!--             <li class="nav-item" role="presentation">
              <button class="nav-link" id="multi-tab" data-bs-toggle="tab" data-bs-target="#del" type="button" role="tab">åˆªé™¤é è³¼</button>
            </li> -->
          </ul>
      
          <!-- Tab Content -->
          <div class="tab-content" id="flavorTabsContent">
            <!-- æ–°å¢åœ˜è³¼/é è³¼ -->
            <div class="tab-pane fade show active" id="add" role="tabpanel" aria-labelledby="add-tab">
              
              <div class="p-4 bg-light rounded shadow-sm">
                <div class="mb-3">
                  <label class="form-label"><span class="text-danger">*</span> å“é …åç¨±</label>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="itemType" value="new" checked onchange="toggleItem()">
                    <label class="form-check-label">æ–°å“é …</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="itemType" value="old" onchange="toggleItem()">
                    <label class="form-check-label">èˆŠå“é …</label>
                  </div>
                </div>

                <!-- æ–°å“é … -->
                <div id="newItem" class="mb-3">
                  <input type="text" class="form-control" id="itemName" required>
                </div>

                <!-- èˆŠå“é … -->
                <div id="oldItem" class="mb-3" style="display: none;">
                  <select class="form-select w-100" id="itemNames" onchange="setItemData(this)" required></select>
                </div>
            
                <div class="mb-3">
                  <label class="form-label">åœ˜è³¼æœŸé–“ </label>
                  <input type="text" class="form-control" id="rangePicker" placeholder="è«‹é¸æ“‡æ™‚é–“ç¯„åœ" style="margin-top: 0.4rem;">
                </div>
            
                <!-- å–®/å¤šå£å‘³åˆ‡æ› -->
                <div class="mb-3">
                  <label class="form-label">å£å‘³é¸æ“‡</label><br>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="flavorType" value="single" checked onchange="toggleFlavor(this.value)">
                    <label class="form-check-label">å–®å£å‘³</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="flavorType" value="multiple" onchange="toggleFlavor(this.value)">
                    <label class="form-check-label">å¤šå£å‘³</label>
                  </div>
                </div>
            
                <!-- å–®å£å‘³ -->
                <div id="singleFlavor" class="mb-3">
                  <label class="form-label"><span class="text-danger">*</span> åƒ¹æ ¼èˆ‡é™é‡(â€» 0ç‚ºä¸é™é‡)</label>
                  <div class="row g-2 mb-2">
                      <div class="col">
                        <input type="number" class="form-control" id="price" min="1" placeholder="åƒ¹æ ¼">
                      </div>
                      <div class="col">
                        <input type="number" class="form-control" id="singleLimit" placeholder="æ•¸é‡" value="0">
                      </div>
                  </div>
                </div>
            
                <!-- å¤šå£å‘³ -->
                <div id="multiFlavor" class="mb-3" style="display: none;">
                  <label class="form-label"><span class="text-danger">*</span> å£å‘³èˆ‡é™é‡(â€» 0ç‚ºä¸é™é‡)</label>
                  <div id="flavorWrapper">
                    <div class="row g-2 mb-2 flavor-row">
                      <div class="col">
                        <input type="number" class="form-control flavor-price" min="1" placeholder="åƒ¹æ ¼">
                      </div>
                      <div class="col">
                        <input type="text" class="form-control flavor-name" placeholder="å£å‘³">
                      </div>
                      <div class="col">
                        <input type="number" class="form-control flavor-limit" placeholder="æ•¸é‡" value="0">
                      </div>
                    </div>
                    <div class="row g-2 mb-2 flavor-row">
                      <div class="col">
                        <input type="number" class="form-control flavor-price" min="1" placeholder="åƒ¹æ ¼">
                      </div>
                      <div class="col">
                        <input type="text" class="form-control flavor-name" placeholder="å£å‘³">
                      </div>
                      <div class="col">
                        <input type="number" class="form-control flavor-limit" placeholder="æ•¸é‡" value="0">
                      </div>
                    </div>
                  </div>
                  <button class="btn btn-outline-primary w-100" onclick="addFlavor()">
                    <i class="fas fa-plus"></i> æ–°å¢å£å‘³
                  </button>
                </div>
          
                <div id="singleFlavor" class="mb-3">
                  <label for="note">å‚™è¨»</label>
                  <input type="text" class="form-control" id="note" />
                </div>
            
                <button class="btn btn-success w-100" id="createOrder" onclick="submitForm()">å»ºç«‹åœ˜è³¼</button>
              </div>
            </div>
          
            <!-- åˆªé™¤åœ˜è³¼/é è³¼ -->
<!--             <div class="tab-pane fade" id="del" role="tabpanel" aria-labelledby="del-tab">
              
            </div> -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¶­è­· Modal è¡¨å–® -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ç¶­è­·åœ˜è³¼é …ç›®</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Tabs -->
          <ul class="nav nav-tabs mb-3" id="Tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab">ç·¨è¼¯åœ˜è³¼</button>
            </li>
          </ul>
      
          <!-- Tab Content -->
          <div class="tab-content" id="editTabsContent">
            <!-- æ–°å¢åœ˜è³¼/é è³¼ -->
            <div class="tab-pane fade show active" id="edit" role="tabpanel" aria-labelledby="edit-tab">
              
              <div class="p-4 bg-light rounded shadow-sm">
                <h5 class="mb-3">è¨‚è³¼æ˜ç´°</h5>
                <div class="accordion" id="orderAccordion"></div>
                <div class="container mt-4" id="itemContainer"></div>
              </div>
            </div>
          
            <!-- åˆªé™¤åœ˜è³¼/é è³¼ -->
<!--             <div class="tab-pane fade" id="del" role="tabpanel" aria-labelledby="del-tab">
              
            </div> -->
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

  const mask = document.getElementById('loadingMask');

  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzPsykyiZtuGZP2uUKN1RE0tJmS8H6zfJqoTaZOekqjyueJ1cqpjGaWXRcX0waCQiugeA/exec'; // æ”¹ç‚ºä½ çš„ Apps Script ç¶²å€

  let data;
  let prd_list;
  let flv_list;
  let fp;

  document.addEventListener('DOMContentLoaded', function () {
    data = fetchData();
  });

  async function fetchData(){

    try {
      mask.style.display = 'flex';
      const res = await fetch(GAS_URL);
      data = await res.json();

      prd_list = data['å“é …åˆ—è¡¨'];
      flv_list = data['å£å‘³åˆ—è¡¨'];
      prd_list = prd_list.sort((a, b) => Number(b.ID) - Number(a.ID));
      // console.log(data);

      const nodel = ['å·²çµå–®', 'å»¶å¾Œä¸­'];

      // 1. éŠ·æ¯€åŸæœ¬ DataTable
      if ( $.fn.DataTable.isDataTable('#example') ) {
        $('#example').DataTable().clear().destroy();
      }
      
      // 2. æ¸…ç©º table bodyï¼ˆé¿å…é‡è¤‡è³‡æ–™ï¼‰
      $('#tableBody').empty();
  
      const tbody = document.getElementById('tableBody');
      prd_list.forEach(item => {

        var view = `<a href="#" class="link-warning text-decoration-none" data-id="${item.ID}" data-name="${item.åç¨±}" onclick="viewModal(this)"><i class="fas fa-eye"></i></a>`;
        var edit = `<a href="#" class="link-success text-decoration-none" data-id="${item.ID}" data-name="${item.åç¨±}" onclick="editModal(this)"><i class="fas fa-pencil-alt"></i></a>`;
        var del  = `<a href="#" class="link-danger text-decoration-none" data-id="${item.ID}" data-name="${item.åç¨±}" onclick="delConfirm(this)"><i class="far fa-trash-alt"></i></a>`;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td title="${item.åç¨± || ''}" class="truncate">${item.åç¨± || ''}</td>
          <td>${item.ç‹€æ…‹ || ''}</td>
          <td>
            ${item.ç‹€æ…‹ === 'å·²çµå–®' ? view : item.ç‹€æ…‹ === 'é–‹å•Ÿä¸­' ? edit : ''}
            &nbsp;
            ${!nodel.includes(item.ç‹€æ…‹) ? del : ''}
          </td>
        `;
        tbody.appendChild(row);
      });
  
      $('#example').DataTable({
        responsive: true,      // å¦‚æœä½ æœ‰ä½¿ç”¨ Bootstrap ç­‰ RWD æ¡†æ¶
        autoWidth: false,      // é—œé–‰è‡ªå‹•æ¬„å¯¬
        pageLength: 5,           // ä¸€é é¡¯ç¤º 5 ç­†
        lengthChange: false,     // ä¸é¡¯ç¤ºç­†æ•¸è¨­å®šä¸‹æ‹‰é¸å–®
        searching: false,
        ordering: false, // ä¸å•Ÿç”¨æ¬„ä½æ’åº
        language: {
          paginate: { previous: 'â€¹', next: 'â€º' },
          zeroRecords: 'ç›®å‰æ²’æœ‰è³‡æ–™',
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
        }
      });

      fp = flatpickr("#rangePicker", {
        mode: "range",
        enableTime: true,
        dateFormat: "m-d H:i",
        locale: "zh",
        minDate: "today" // âœ… é™åˆ¶ä»Šå¤©ä»¥å‰ä¸èƒ½é¸
      });
    } catch (err) {
      console.error('è®€å– Google Sheet è³‡æ–™å¤±æ•—', err);
    } finally {
      mask.style.display = 'none';
    }
    return data;
  }

  function addGroupBuyModal(){
    fp.clear();
    $('input[type="text"]').val('');
    resetForm();
    $('#groupBuyModal').modal('show');
  }

  function toggleItem() {
    const selected = document.querySelector('input[name="itemType"]:checked').value;
    document.getElementById("newItem").style.display = selected === "new" ? "block" : "none";
    document.getElementById("oldItem").style.display = selected === "old" ? "block" : "none";

    if( selected=='old' ){
      // console.log(data);
      const oldName = prd_list.filter((item, index, self) =>
        index === self.findIndex(t => t.åç¨± === item.åç¨±)
      );
      // console.log(oldName);
      $('#itemNames').empty(); // æ¸…ç©ºåŸæœ‰å…§å®¹ï¼ˆè‹¥æœ‰ï¼‰

      $('#itemNames').append('<option value="" selected disabled hidden>è«‹é¸æ“‡å“é …</option>');
      
      // å°‡ oldName é™£åˆ—åŠ å…¥ select ä¸­
      oldName.forEach(item => {
        $('#itemNames').append(`<option value="${item.ID}">${item.åç¨±}</option>`);
      });
    
      // åˆå§‹åŒ– Select2
      $('#itemNames').select2({
        dropdownParent: $('#groupBuyModal'),
        placeholder: 'è«‹é¸æ“‡å“é …',
        allowClear: true,
        width: 'resolve'
      });
    }
  }

  function setItemData(item){

    resetForm();
    
    var id  = Number(item.value);

    if( id ){
      if( prd_list ){ var prd = prd_list.find(item => item.ID === id); }
      if( flv_list ){ var flv = flv_list.find(item => item.å“é …ID === id); }
      const checked = $('input[name="flavorType"]:checked');

      if( !prd ){ return; }
  
      if( prd.å”®åƒ¹=='---' ){ // ä»£è¡¨æ˜¯å¤šå£å‘³
        if( checked.val()=='single' ){ $('input[name="flavorType"][value="multiple"]').prop('checked', true); toggleFlavor("multiple"); }
        
        const results = flv_list.filter(item => item.å“é …ID === id);
        
        var num = results.length-2;
        if( num>0 ){ for(i=0; i<num; i++){ addFlavor(); } }
  
        $('.flavor-row').each(function(index, row) {
          $(row).find('.flavor-name').val(results[index].å£å‘³);
          $(row).find('.flavor-price').val(results[index].åƒ¹æ ¼);
          $(row).find('.flavor-limit').val(results[index].é™é‡);
        });
      }else{ // å–®å£å‘³
        if( checked.val()=='multiple' ){ $('input[name="flavorType"][value="single"]').prop('checked', true); toggleFlavor("single"); }
        if( prd ){ $("#price").val(prd.å”®åƒ¹); }
        if( flv ){ $("#singleLimit").val(flv.é™é‡); }else{ $("#singleLimit").val(0); } // æ‰¾åˆ°è©²å“é …ï¼Œä»£è¡¨æœ‰é™é‡
      }
    }
  }

  function toggleFlavor(type) {
    const selected = type;
    document.getElementById("singleFlavor").style.display = selected === "single" ? "block" : "none";
    document.getElementById("multiFlavor").style.display = selected === "multiple" ? "block" : "none";
  }
  

  function addFlavor() {
    const div = document.createElement('div');
    div.className = "row g-2 mb-2 flavor-row";
    div.innerHTML = `
      <div class="col"><input type="number" class="form-control flavor-price" min="1" placeholder="åƒ¹æ ¼"></div>
      <div class="col"><input type="text" class="form-control flavor-name" placeholder="å£å‘³"></div>
      <div class="col"><input type="number" class="form-control flavor-limit" placeholder="æ•¸é‡"></div>
      <div class="col-auto"><button class="btn btn-outline-danger" onclick="removeFlavor(this)"><i class="fas fa-times"></i></button></div>
    `;
    document.getElementById("flavorWrapper").appendChild(div);
  }

  function removeFlavor(btn) {
    btn.closest('.flavor-row').remove();
  }

  async function viewModal(e){
    
    $('#editModal').modal('show');

    const id = e.dataset.id;
    const name = e.dataset.name;

    const data = {
      type: 'view',
      userId: userId,
      id: id,
      name: name
    };
    
    try {
      mask.style.display = 'flex';
      const response = await fetch(GAS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain',
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      // console.log(result);

      if (result[0].status == 'success') {
        var ords  = result[0].orders;
        var $list = $('#orderSummaryList');
        $list.empty();
        
        const grouped = {};
        ords.forEach(user => {
          if (!grouped[user.name]) grouped[user.name] = [];
          if( user.orders.length>0 ){
            user.orders.forEach(ord => {
              grouped[user.name].push({ flavor: ord.taste, qty: ord.count });
            });
          }
        });
        
        // æ¸²æŸ“ Accordion
        const $accordion = $('#orderAccordion');
        $accordion.empty();
    
        let i = 0;
        for (const [name, orders] of Object.entries(grouped)) {
          const collapseId = `collapse${i}`;
          const headerId = `heading${i}`;
    
          const flavorList = orders.map(o => {
            // å¦‚æœ flavor æ˜¯ç©ºçš„æˆ–èˆ‡ name ç›¸åŒï¼Œå°±åªé¡¯ç¤ºå“é …æ•¸é‡
            if (!o.flavor || o.flavor === name) {
              return `<li class="list-group-item">${name}ï¼š${o.qty}</li>`;
            } else {
              return `<li class="list-group-item">${name} - ${o.flavor}ï¼š${o.qty}</li>`;
            }
          }).join('');
    
          const item = `
            <div class="accordion-item">
              <h2 class="accordion-header" id="${headerId}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                  ${name}
                </button>
              </h2>
              <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headerId}" data-bs-parent="#orderAccordion">
                <div class="accordion-body p-0">
                  <ul class="list-group list-group-flush">
                    ${flavorList}
                  </ul>
                </div>
              </div>
            </div>
          `;
          $accordion.append(item);
          i++;
        }

        // é‡æ–°è¼‰å…¥è³‡æ–™
        // fetchData();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'ç¶­è­·å¤±æ•—',
          text: result[0].alert || 'è«‹ç¨å¾Œå†è©¦'
        });
      }
    } catch (err) {
      console.log(err);
      Swal.fire({
        icon: 'error',
        title: 'ç³»çµ±ç•°å¸¸'
      });
    } finally {
      mask.style.display = 'none';
    }
    
  }

  async function editModal(e){
    
    $('#editModal').modal('show');

    const id = e.dataset.id;
    const name = e.dataset.name;

    const data = {
      type: 'view',
      userId: userId,
      id: id,
      name: name
    };
    
    try {
      mask.style.display = 'flex';
      const response = await fetch(GAS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain',
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      // console.log(result);

      if (result[0].status == 'success') {
        var ords  = result[0].orders;
        var $list = $('#orderSummaryList');
        $list.empty();
        
        const item = [];
        ords.forEach(user => {
          if( user.orders.length>0 ){
            item.push({name:name, flavors:user.orders});
          }
        });

        renderItems(item);

        // ords.forEach((user) => {
        //   if( user.orders.length>0 ){
        //     var del  = `<a href="#" class="link-danger text-decoration-none" data-id="${id}" data-name="${user.name}" onclick="del(this)"><i class="far fa-trash-alt"></i></a>`;
        //     const $row = $(`
        //       <tr>
        //         <td>${user.name}</td>
        //         <td>${user.taste}</td>
        //         <td>${user.count}</td>
        //         <td>${del}</td>
        //       </tr>
        //     `);
        //     $tbody.append($row);
        //   }
        // });

      } else {
        Swal.fire({
          icon: 'error',
          title: 'ç¶­è­·å¤±æ•—',
          text: result[0].alert || 'è«‹ç¨å¾Œå†è©¦'
        });
      }
    } catch (err) {
      console.log(err);
      Swal.fire({
        icon: 'error',
        title: 'ç³»çµ±ç•°å¸¸'
      });
    } finally {
      mask.style.display = 'none';
    }
    
  }

  function renderItems(items) {
    const container = document.getElementById("itemContainer");
    container.innerHTML = ''; // æ¸…ç©º
  
    items.forEach((item, index) => {
      const collapseId = `itemDetail${index}`;
      
      const flavorList = item.flavors.map(f =>
        `<li class="list-group-item">${f.taste} - æ•¸é‡ ${f.count}</li>`
      ).join('');
  
      const card = document.createElement("div");
      card.className = "card mb-3";
  
      card.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <strong>ğŸª ${item.name}</strong><br>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="editItem(${index})">ç·¨è¼¯</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${index})">åˆªé™¤</button>
            <button class="btn btn-sm btn-link" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">
              è©³ç´° â–¼
            </button>
          </div>
        </div>
        <div class="collapse" id="${collapseId}">
          <div class="card-body p-0">
            <ul class="list-group list-group-flush">
              ${flavorList}
            </ul>
          </div>
        </div>
      `;
  
      container.appendChild(card);
    });
  }

  function delConfirm(e){
    
    Swal.fire({
      title: 'ä½ ç¢ºå®šå—ï¼Ÿ',
      text: 'æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'ç¢ºå®š',
      cancelButtonText: 'å–æ¶ˆ'
    }).then((result) => {
      if (result.isConfirmed) {
        delOrder(e);
      } else if (result.isDismissed) {
        // ä½¿ç”¨è€…æŒ‰ä¸‹ã€Œå–æ¶ˆã€æˆ–é»æ—é‚Šé—œé–‰
        console.log('ä½¿ç”¨è€…å–æ¶ˆ');
      }
    });
  }

  async function delOrder(e){
    
    const id = e.dataset.id;
    const name = e.dataset.name;

    const data = {
      type: 'delete',
      userId: userId,
      id: id,
      name: name
    };
    
    try {
      mask.style.display = 'flex';
      const response = await fetch(GAS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain',
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result[0].status == 'success') {
        Swal.fire({
          icon: 'success',
          title: 'åˆªé™¤æˆåŠŸ',
          text: `å“é …ã€Œ${name}ã€å·²åˆªé™¤ï¼`
        });

        // é‡æ–°è¼‰å…¥è³‡æ–™
        fetchData();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'åˆªé™¤å¤±æ•—',
          text: result[0].alert || 'è«‹ç¨å¾Œå†è©¦'
        });
      }
    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'ç³»çµ±ç•°å¸¸'
      });
    } finally {
      mask.style.display = 'none';
    }
    
  }

  function resetForm() {

    // 1. é‚„åŸ radio é è¨­ (å‡è¨­é è¨­æ˜¯ single)
    $('input[name="flavorType"][value="single"]')
      .prop('checked', true)
      .trigger('change');    // è§¸ç™¼ toggleFlavor()
  
    // 2. æ¸…ç©ºæ‰€æœ‰æ¬„ä½ (input, select, textarea)
    $('#singleFlavor, #multiFlavor').find('input')
      .val('')               // æ¸…ç©ºæ–‡å­— / æ•¸å­—
      .prop('checked', false) // å–æ¶ˆ checkbox / radio
      .prop('selected', false); // å–æ¶ˆ select é¸é …
  
    // 3. å¦‚æœ multiFlavor æœ‰å‹•æ…‹æ–°å¢çš„ .flavor-rowï¼Œç•™ç¬¬ä¸€åˆ—ç§»é™¤å…¶é¤˜
    $('#flavorWrapper .flavor-row').slice(2).remove();
  }
  
  async function submitForm() {

    if (!userId) {
      alert("âš ï¸ å°šæœªå–å¾— userId");
      return;
    }

    let name    = document.getElementById('itemName').value.trim();
    const id    = document.getElementById('itemNames').value.trim();
    const range = document.getElementById('rangePicker').value;

    if ( !name && !id ) {
      Swal.fire('è«‹å¡«å¯«åç¨±');
      return;
    }

    if( id ){ 
      var prd = prd_list.find(item => item.ID === Number(id));
      if( prd ){ name = prd.åç¨±; }
    }
    
    const flavorType = document.querySelector('input[name="flavorType"]:checked').value;
  
    let flavors = [];
    let limit = 0;
    let price = [];
  
    if (flavorType === 'single') {
      const singleLimit = parseInt(document.getElementById('singleLimit').value);
      p = parseInt(document.getElementById('price').value);
      if ( p<=0 ) {
        Swal.fire('åƒ¹æ ¼ä¸èƒ½ç‚º0æˆ–å°æ–¼0');
        return;
      }
      if (isNaN(singleLimit) || singleLimit < 0) {
        Swal.fire('è«‹è¼¸å…¥æœ‰æ•ˆçš„é™é‡');
        return;
      }
      price.push(p);
      limit = singleLimit;
    } else {
      const flavorRows = document.querySelectorAll('.flavor-row');
      for (const row of flavorRows) {
        const name = row.querySelector('.flavor-name').value.trim();
        const p = row.querySelector('.flavor-price').value.trim();
        const limitValue = parseInt(row.querySelector('.flavor-limit').value);
        if (!name || isNaN(limitValue) || limitValue < 0 || p <= 0) {
          Swal.fire('è«‹å¡«å¯«æ‰€æœ‰å£å‘³èˆ‡æœ‰æ•ˆæ•¸é‡åŠåƒ¹æ ¼');
          return;
        }
        price.push(p);
        flavors.push({ flavor: name, num: limitValue, price: p });
      }
      if (flavors.length === 0) {
        Swal.fire('è‡³å°‘æ–°å¢ä¸€å€‹å£å‘³');
        return;
      }
    }

    const data = {
      type: 'create',
      userId: userId,
      name: name,
      range: range,
      // type: flavorType,
      limit: limit,
      price: price,
      flavors: flavors
    };

    // âœ… Google Apps Script ç¶²å€
    // const GAS_URL = 'https://script.google.com/macros/s/AKfycbzaBwM3tnLtj56n8_s71FyrAD5Dbxc39iPPHubUALvtxZx8tSHyoPKtASDZVZ_1v9byvg/exec';

    try {
      mask.style.display = 'flex';
      const response = await fetch(GAS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain',
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result[0].status == 'success') {
        Swal.fire({
          icon: 'success',
          title: 'é€å‡ºæˆåŠŸ',
          text: `å“é …ã€Œ${name}ã€å·²æ–°å¢ï¼`
        });

        $('#groupBuyModal').modal('hide');
        $('#rangePicker').flatpickr().clear();
        $('input[type="text"]').val('');
        $('input[type="number"]').val('');

        // æ¸…ç©ºè¡¨å–®
        resetForm();

        // é‡æ–°è¼‰å…¥è³‡æ–™
        fetchData();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'é€å‡ºå¤±æ•—',
          text: result[0].alert || 'è«‹ç¨å¾Œå†è©¦'
        });
      }
    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'ç³»çµ±ç•°å¸¸'
      });
    } finally {
      mask.style.display = 'none';
    }
  }
</script>
</html>
