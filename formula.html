<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>配方/材料</title>

	<!-- Custom Style -->
    <link href="style.css" rel="stylesheet" />

    <!-- Bootstrap & Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Custom Js -->
    <script src="main.js"></script>
  
    <!-- DataTables + Bootstrap 5 -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  
    <!-- Vue 2 -->
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
</head>
<body data-page="formula">
	<div id="app">

		<div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">配方列表</h3>
                        <div class="card-tools">
                            <a class="link-primary" style="cursor: pointer;" @click="newModal()">
                                <i class="fa fa-plus"></i>
                                新增
                            </a>
                        </div>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body table-responsive p-0">
                    	<table id="example" class="table table-striped table-hover table-bordered w-100">
		                    <thead>
		                        <tr>
		                            <th>名稱</th>
		                            <th>狀態</th>
		                            <th></th>
		                        </tr>
		                    </thead>
		                    <tbody id="tableBody"></tbody>
		                </table>
                    </div>
                    <!-- /.card-body -->
                    <!-- <div class="card-footer">
                    </div> -->
                </div>
                <!-- /.card -->
            </div>
        </div>

		<!-- 底部導覽載入位置 -->
		<div id="bottomNav"></div>

		<!-- 新增配方 Modal -->
		<div class="modal fade" id="formulaModal" tabindex="-1">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">新增配方</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">

					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>

	new Vue({
		el: '#app',
		data: {
			msg: '',
			userId: 'test',
			formulas: { data: [] },
		},
		methods: {

			loadFormulas() {

				// var ym = this.getLastMonth();
				// ⬇ 取得 users/test/202503_schedules
				db.ref("users/" + this.userId + "/formulas").on("value", (snapshot) => {
					const raw = snapshot.val();

					let events = [];

					if (raw) {

						let parsed = JSON.parse(raw);

						let list = parsed.data || [];

						events = list.map(item => ({
							id: item.id,
							title: item.name + "：" + item.content,
							start: item.start,
							end: item.end
						}));

						$('#example').DataTable({
			                data: prd_list,
			                destroy: true, // 重新載入時清除舊表格
			                responsive: true,      // 如果你有使用 Bootstrap 等 RWD 框架
			                autoWidth: false,      // 關閉自動欄寬
			                pageLength: 5,           // 一頁顯示 5 筆
			                lengthChange: false,     // 不顯示筆數設定下拉選單
			                searching: false,
			                ordering: false, // 不啟用欄位排序
			                language: {
			                    paginate: { previous: '‹', next: '›' },
			                    zeroRecords: '目前沒有資料',
			                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
			                },
			                initComplete: function () {
			                    mask.style.display = 'none';
			                },
			                columns: [
			                    { data: '名稱', className: 'truncate' },
			                    { 
			                        data: '狀態',
			                        className: 'text-center',
			                        createdCell: function (td, cellData) {
			                            if (cellData === true) {
			                                $(td).addClass('text-success');
			                            } else if (cellData === false) {
			                                $(td).addClass('text-danger');
			                            }
			                        }
			                    },
			                    {
			                        data: null,
			                        className: 'text-center',
			                        render: function (data, type, row) {
			              
			                            // const nodel = ['已結單', '延後中'];
			              
			                            // var flavor = (row.售價 === '---' ? 2 : 1);

			                            // var open = `<a href="#" class="dropdown-item link-dark text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-row='${JSON.stringify(row)}' data-type="open" onclick="cartModal(this)"><i class="fas fa-cart-plus"></i> 開啟訂單</a>`;
			                            // var view = `<a href="#" class="dropdown-item link-warning text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-flavor="${flavor}" data-type="view" onclick="updModal(this)"><i class="fas fa-eye"></i></a>`;
			                            // var edit = `<a href="#" class="dropdown-item link-success text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-flavor="${flavor}" data-type="edit" onclick="editModal(this)"><i class="fas fa-edit"></i> 編輯訂單</a>`;
			                            // var upd = `<a href="#" class="dropdown-item link-purple text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-flavor="${flavor}" data-type="upd" onclick="updModal(this)"><i class="fas fa-list-alt"></i> 管理訂單</a>`;
			                            // var chk  = `<a href="#" class="dropdown-item link-secondary text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-type="chkout" onclick="orderConfirm(this)"><i class="fas fa-money-check-alt"></i> 結算訂單</a>`;
			                            // var agent = `<a href="#" class="dropdown-item link-warning text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-type="agent" onclick="AgentModal(this)"><i class="fas fa-hand-holding-medical"></i> 代購訂單</a>`;
			                            // var del  = `<a href="#" class="dropdown-item link-danger text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-type="delete" onclick="orderConfirm(this)"><i class="far fa-trash-alt"></i> 刪除訂單</a>`;
			                            // <span class="badge bg-success">Beta</span>

			                            // var menu = `
			                            //     <div class="dropdown">
			                            //         <a href="#" class="link-dark" role="button" data-bs-toggle="dropdown" aria-expanded="false">
			                            //             <i class="fas fa-bars"></i>
			                            //         </a>
			                            //         <ul class="dropdown-menu dropdown-menu-end">
			                            //             <li>${open}</li>
			                            //             <li>${edit}</li>
			                            //             <li>${upd}</li>
			                            //             <li>${chk}</li>
			                            //             <li>${agent}</li>
			                            //             <li>${del}</li>
			                            //         </ul>
			                            //     </div>
			                            // `;
			                    
			                            // var html = row.備註; // 延後中
			                            // if( row.狀態==='已結單' ){ html = view; }
			                            // if( row.狀態==='開啟中' ){ html = menu; }

			                            // return html;
			                        }
			                    }
			                ]
			            });
					}
				});
			},

			async getFirebaseData() {

				let formulas;

				const def = db.ref('users/' + this.userId + '/formulas');
				const data = await def.once("value");

				if (data.exists()) {
					formulas = JSON.parse(data.val());
					this.formulas = formulas;
				}
			},

			// renderCalendar(events) {
			// 	let calEl = document.getElementById("calendar");
			// 	calEl.innerHTML = ""; // 清除舊日曆

			// 	let calendar = new FullCalendar.Calendar(calEl, {
			// 		initialView: "dayGridMonth",
			// 		locale: "zh-tw",
			// 		events: events,
			// 		height: "auto",
			// 		editable: true,     // 允許拖曳 / resize
			// 		selectable: true,   // 可拉區間新增
			// 		dayMaxEvents: true,
			// 		dateClick: async (info) => { // 點日期新增

			// 			const title = prompt("輸入事件名稱(Ex: 事件名稱:事件內容)");
			// 			if (!title) return;
			// 			if (!/[:：]/.test(title)) { alert('請參照範例格式新增事件!!'); }

			// 			calendar.addEvent({
			// 				title,
			// 				start: info.dateStr,
			// 				allDay: true
			// 			});

			// 			await this.getFirebaseData();

			// 			// TODO: 存 DB(Firebase database)
			// 			this.addEvent({
			// 				title: title,
			// 				start: info.dateStr,
			// 				end: info.dateStr,
			// 				allDay: true
			// 			});
			// 		},

			// 		select: async (info) => { // 拉區間新增

			// 			const title = prompt("輸入事件名稱");
			// 			if (!title) return;
			// 			if (!/[:：]/.test(title)) { alert('請參照範例格式新增事件!!'); }

			// 			calendar.addEvent({
			// 				title,
			// 				start: info.startStr,
			// 				end: info.endStr,
			// 				allDay: info.allDay
			// 			});

			// 			calendar.unselect();

			// 			await this.getFirebaseData();

			// 			// TODO: 存 DB
			// 			this.addEvent({
			// 				title: title,
			// 				start: info.startStr,
			// 				end: info.endStr,
			// 				allDay: info.allDay
			// 			});
			// 		},

			// 		eventClick: async (info) => { // 點擊事件（編輯 / 刪除）

			// 			const action = confirm("按「確定」= 刪除\n按「取消」= 修改標題");

			// 			await this.getFirebaseData();

			// 			if (action) {
			// 				info.event.remove();
			// 				// TODO: 刪除 DB
			// 				this.delEvent(info.event.id);

			// 			} else {

			// 				const newTitle = prompt("修改事件名稱", info.event.title);
			// 				if (!newTitle) return;
			// 				if (!/[:：]/.test(newTitle)) { alert('請參照範例格式修改事件!!'); }

			// 				if (newTitle) {
			// 					info.event.setProp("title", newTitle);
			// 					// TODO: 更新 DB
			// 					this.updEvent(info.event.id, newTitle);
			// 				}
			// 			}
			// 		},

			// 		eventDrop: async (info) => { // 拖曳事件（改日期）
			// 			// info.event.start / info.event.end
			// 			console.log("拖曳後", info.event);

			// 			await this.getFirebaseData();

			// 			// API 失敗可回復
			// 			// info.revert();
			// 			// TODO: 更新 DB
			// 			this.dropEvent(info.event.id, info.event.startStr, info.event.endStr);
			// 		},

			// 		eventResize(info) { // 拉長 / 縮短
			// 			console.log("resize 後", info.event);
			// 			// TODO: 更新 DB
			// 		}
			// 	});

			// 	calendar.render();
			// },

		},
		async mounted() {

			await liff.init({ liffId: '2007457926-5wAYNP0w' });

			if (!liff.isLoggedIn()) {
				liff.login();
				return;
			}

			this.profile = await liff.getProfile();
			this.userId  = this.profile.userId;

			this.loadFormulas();
		}
	});
</script>
</html>