<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>配方/材料</title>

	<!-- Custom Style -->
    <link href="style.css" rel="stylesheet" />

    <!-- Bootstrap & Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Custom Js -->
    <script src="main.js"></script>
  
    <!-- DataTables + Bootstrap 5 -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  
    <!-- Vue 2 -->
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
</head>
<style>
	#loadingMask {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
</style>
<body data-page="formula">
	<div id="app">

		<div class="container mt-4">
        	<div class="card">
            	<div class="card-header d-flex justify-content-between align-items-center">
            		<h5 class="mb-0">品項列表</h5>
            		<a href="#" class="link-primary" onclick="addFormulaModal()">
	                    <i class="fas fa-plus"></i> 新增
	                </a>
            	</div>
            	<div class="card-body">
            		<table id="example" class="table table-striped table-hover table-bordered w-100">
	                    <thead>
	                        <tr>
	                            <th>名稱</th>
	                            <th>狀態</th>
	                            <th></th>
	                        </tr>
	                    </thead>
	                    <tbody id="tableBody"></tbody>
	                </table>
            	</div>
            </div>
        </div>

		<!-- 底部導覽載入位置 -->
		<div id="bottomNav"></div>

		<div id="loadingMask"><div class="spinner"></div></div>

		<!-- 新增配方 Modal -->
		<div class="modal fade" id="formulaModal" tabindex="-1">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">新增配方</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">

					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
	const mask = document.getElementById('loadingMask');
</script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>

	new Vue({
		el: '#app',
		data: {
			msg: '',
			userId: 'test',
			formulas: { data: [] },
		},
		methods: {

			loadFormulas() {

				// var ym = this.getLastMonth();
				// ⬇ 取得 users/test/202503_schedules
				db.ref("users/" + this.userId + "/formulas").on("value", (snapshot) => {
					const raw = snapshot.val();

					let events = [];

					if (raw) {

						let parsed = JSON.parse(raw);
						console.log(parsed);

						// let list = parsed.data || [];

						// events = list.map(item => ({
						// 	id: item.id,
						// 	title: item.name + "：" + item.content,
						// 	start: item.start,
						// 	end: item.end
						// }));
						mask.style.display = 'flex';

						$('#example').DataTable({
			                data: parsed.data,
			                destroy: true, // 重新載入時清除舊表格
			                responsive: true,      // 如果你有使用 Bootstrap 等 RWD 框架
			                autoWidth: false,      // 關閉自動欄寬
			                pageLength: 5,           // 一頁顯示 5 筆
			                lengthChange: false,     // 不顯示筆數設定下拉選單
			                searching: false,
			                ordering: false, // 不啟用欄位排序
			                language: {
			                    paginate: { previous: '‹', next: '›' },
			                    zeroRecords: '目前沒有資料',
			                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
			                },
			                initComplete: function () {
			                    mask.style.display = 'none';
			                },
			                columns: [
			                    { data: '名稱', className: 'truncate' },
			                    { 
			                        data: '狀態',
			                        className: 'text-center',
			                        createdCell: function (td, cellData) {
			                            if (cellData === true) {
			                                $(td).addClass('text-success');
			                            } else if (cellData === false) {
			                                $(td).addClass('text-danger');
			                            }
			                        }
			                    },
			                    {
			                        data: null,
			                        className: 'text-center',
			                        render: function (data, type, row) {
			              
			                            // const nodel = ['已結單', '延後中'];
			              
			                            // var flavor = (row.售價 === '---' ? 2 : 1);

			                            // var open = `<a href="#" class="dropdown-item link-dark text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-row='${JSON.stringify(row)}' data-type="open" onclick="cartModal(this)"><i class="fas fa-cart-plus"></i> 開啟訂單</a>`;
			                            // var view = `<a href="#" class="dropdown-item link-warning text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-flavor="${flavor}" data-type="view" onclick="updModal(this)"><i class="fas fa-eye"></i></a>`;
			                            // var edit = `<a href="#" class="dropdown-item link-success text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-flavor="${flavor}" data-type="edit" onclick="editModal(this)"><i class="fas fa-edit"></i> 編輯訂單</a>`;
			                            // var upd = `<a href="#" class="dropdown-item link-purple text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-flavor="${flavor}" data-type="upd" onclick="updModal(this)"><i class="fas fa-list-alt"></i> 管理訂單</a>`;
			                            // var chk  = `<a href="#" class="dropdown-item link-secondary text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-type="chkout" onclick="orderConfirm(this)"><i class="fas fa-money-check-alt"></i> 結算訂單</a>`;
			                            // var agent = `<a href="#" class="dropdown-item link-warning text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-type="agent" onclick="AgentModal(this)"><i class="fas fa-hand-holding-medical"></i> 代購訂單</a>`;
			                            // var del  = `<a href="#" class="dropdown-item link-danger text-decoration-none" data-id="${row.ID}" data-name="${row.名稱}" data-type="delete" onclick="orderConfirm(this)"><i class="far fa-trash-alt"></i> 刪除訂單</a>`;
			                            // <span class="badge bg-success">Beta</span>

			                            // var menu = `
			                            //     <div class="dropdown">
			                            //         <a href="#" class="link-dark" role="button" data-bs-toggle="dropdown" aria-expanded="false">
			                            //             <i class="fas fa-bars"></i>
			                            //         </a>
			                            //         <ul class="dropdown-menu dropdown-menu-end">
			                            //             <li>${open}</li>
			                            //             <li>${edit}</li>
			                            //             <li>${upd}</li>
			                            //             <li>${chk}</li>
			                            //             <li>${agent}</li>
			                            //             <li>${del}</li>
			                            //         </ul>
			                            //     </div>
			                            // `;
			                    
			                            // var html = row.備註; // 延後中
			                            // if( row.狀態==='已結單' ){ html = view; }
			                            // if( row.狀態==='開啟中' ){ html = menu; }

			                            // return html;
			                        }
			                    }
			                ]
			            });
					}
				});
			},

			async getFirebaseData() {

				let formulas;

				const def = db.ref('users/' + this.userId + '/formulas');
				const data = await def.once("value");

				if (data.exists()) {
					formulas = JSON.parse(data.val());
					this.formulas = formulas;
				}
			},

		},
		async mounted() {

			await liff.init({ liffId: '2007457926-5wAYNP0w' });

			if (!liff.isLoggedIn()) {
				liff.login();
				return;
			}

			this.profile = await liff.getProfile();
			this.userId  = this.profile.userId;

			this.loadFormulas();
		}
	});
</script>
</html>