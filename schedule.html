<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Vue 2 + FullCalendar</title>

	<!-- Custom Style -->
    <link href="style.css" rel="stylesheet" />

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Custom Js -->
    <script src="main.js"></script>

    <!-- Vue 2 -->
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

	<!-- FullCalendar CSS & JS -->
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

	<!-- Firebase -->
	<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<style>
    #calendar { max-width: 900px; margin: 40px auto; }
</style>
<body>

<div id="app">
	<h1>{{ msg }}</h1>
	<div id="calendar"></div>

	<!-- Â∫ïÈÉ®Â∞éË¶ΩËºâÂÖ•‰ΩçÁΩÆ -->
    <div id="bottomNav"></div>
</div>
<script>
	window.onload = async () => {

        await liff.init({ liffId: "2007457926-5wAYNP0w" });

        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }

        const profile = await liff.getProfile();
        console.log(profile.userId);
        userId = profile.userId;

        // Ê™¢Êü• LocalStorage Âø´Âèñ
        if ( !isUserAuthenticated(userId) ) { 
            authUser(userId); 
        }else{ 
            try{
                mask.style.display = 'flex';
                await fetchData(); 
            } finally {
                mask.style.display = 'none';
            }
        }
        // authUser(userId);
    }
</script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>

	// -----------------------------
	// 1. Firebase Init
	// -----------------------------
	var firebaseConfig = {
		apiKey: "AIzaSyC8m836pO-wSSshMj3tx_C3FPLCmPF4O6Y",
        authDomain: "fir-55dbc.firebaseapp.com",
        databaseURL: "https://fir-55dbc-default-rtdb.firebaseio.com",
        projectId: "fir-55dbc",
        storageBucket: "fir-55dbc.appspot.com",
        messagingSenderId: "545726793239",
        appId: "1:545726793239:web:94567930a3b2a55d5efe52",
        measurementId: "G-R5XS993882"
	};

	firebase.initializeApp(firebaseConfig);

	var db = firebase.database();
	new Vue({
		el: '#app',
		data: {
			msg: ''
		},
		methods: {

			loadSchedules() {
        		// ‚¨á ÂèñÂæó users/test/202503_schedules
        		db.ref("users/test/202503_schedules").on("value", (snapshot) => {
          			const raw = snapshot.val();

          			if (!raw) return;

					// üî• ÈáçË¶ÅÔºö‰Ω†ÁöÑË≥áÊñôÊòØÂ≠ó‰∏≤ ‚Üí ËΩâ JSON
					let parsed = JSON.parse(raw);

					// ÂèñÂá∫ data[]
					let list = parsed.data || [];

					// ËΩâÊàê FullCalendar Ê†ºÂºè
					let events = list.map(item => ({
						id: item.id,
						title: item.name + "Ôºö" + item.content,
						start: item.start,
						end: item.end
					}));

					console.log(events);

					this.renderCalendar(events);
				});
			},

			renderCalendar(events) {
				let calEl = document.getElementById("calendar");
				calEl.innerHTML = ""; // Ê∏ÖÈô§ËàäÊó•ÊõÜ

				let calendar = new FullCalendar.Calendar(calEl, {
			  		initialView: "dayGridMonth",
			  		locale: "zh-tw",
			  		events: events,
			  		height: "auto",
			  		eventClick(info) {
			    		alert("‰∫ã‰ª∂Ôºö" + info.event.title);
			  		}
				});

				calendar.render();
			}
		},
		mounted() {
			this.loadSchedules();
			// var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
			// 	initialView: 'dayGridMonth',
			// 	dateClick: function(info) {
			// 		alert('Clicked: ' + info.dateStr);
			// 	},
			// 	events: [
			// 		{ title: '‰∫ã‰ª∂ A', date: '2025-01-01' },
			// 		{ title: '‰∫ã‰ª∂ B', date: '2025-01-15' }
			// 	]
			// });
			// calendar.render();
		}
	});
</script>

</body>
</html>
