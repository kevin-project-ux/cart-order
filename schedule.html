<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>我的行程</title>

	<!-- Custom Style -->
    <link href="style.css" rel="stylesheet" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Custom Js -->
    <script src="main.js"></script>

    <!-- Vue 2 -->
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

	<!-- FullCalendar CSS & JS -->
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

	<!-- Firebase -->
	<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<style>
    #calendar { max-width: 900px; margin: 40px auto; }
    .fc { padding: 6px; }
</style>
<body data-page="schedule">

	<div id="app">
		<h1>{{ msg }}</h1>
		<div id="calendar"></div>

		<!-- 底部導覽載入位置 -->
	    <div id="bottomNav"></div>
	</div>
</body>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>

	// -----------------------------
	// 1. Firebase Init
	// -----------------------------
	var firebaseConfig = {
		apiKey: "AIzaSyC8m836pO-wSSshMj3tx_C3FPLCmPF4O6Y",
        authDomain: "fir-55dbc.firebaseapp.com",
        databaseURL: "https://fir-55dbc-default-rtdb.firebaseio.com",
        projectId: "fir-55dbc",
        storageBucket: "fir-55dbc.appspot.com",
        messagingSenderId: "545726793239",
        appId: "1:545726793239:web:94567930a3b2a55d5efe52",
        measurementId: "G-R5XS993882"
	};

	firebase.initializeApp(firebaseConfig);

	var db = firebase.database();
	new Vue({
		el: '#app',
		data: {
			msg: '',
			userId: 'test',
		},
		methods: {

			loadSchedules() {

				// var ym = this.getLastMonth();
        		// ⬇ 取得 users/test/202503_schedules
        		db.ref("users/"+this.userId+"/schedules").on("value", (snapshot) => {
          			const raw = snapshot.val();

          			let events = [];

          			if( raw ){

						let parsed = JSON.parse(raw);

						let list = parsed.data || [];

						events = list.map(item => ({
							id: item.id,
							title: item.name + "：" + item.content,
							start: item.start,
							end: item.end
						}));
          			}

					// console.log(events);

					events = this.adjustAllDayEndDates(events);

					this.renderCalendar(events);
				});
			},

			renderCalendar(events) {
				let calEl = document.getElementById("calendar");
				calEl.innerHTML = ""; // 清除舊日曆

				let calendar = new FullCalendar.Calendar(calEl, {
			  		initialView: "dayGridMonth",
			  		locale: "zh-tw",
			  		events: events,
			  		height: "auto",
			  		eventClick(info) {
			    		alert("事件：" + info.event.title);
			  		}
				});

				calendar.render();
			},

			// 自動調整 allDay 事件的 end 日期
		    adjustAllDayEndDates(events) {
		      	return events.map(event => {
			        if (event.end) {
			          	const endDate = new Date(event.end);
			          	endDate.setDate(endDate.getDate() + 1); // +1 天
			          	return {
			            	...event,
			            	end: endDate.toISOString().split('T')[0] // YYYY-MM-DD
			          	};
			        }
		        	return event;
		      	});
		    },

			//抓上個月(年月)
			getLastMonth() {
                const date = new Date(); // 取得當前日期
                date.setMonth(date.getMonth() - 1); // 設定為上個月

                // 格式化為 YYYYMM
                const year = date.getFullYear(); // 取得年份
                const month = (date.getMonth() + 1).toString().padStart(2, '0'); // 取得月份（補0）

                return `${year}${month}`;
            },
		},
		async mounted() {

			await liff.init({ liffId: '2007457926-5wAYNP0w' });

			if (!liff.isLoggedIn()) {
				liff.login();
				return;
			}

			this.profile = await liff.getProfile();
			this.userId = this.profile.userId;

			this.loadSchedules();
		}
	});
</script>
</html>
