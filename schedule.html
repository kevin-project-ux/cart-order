<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>我的行程</title>

	<!-- Custom Style -->
	<link href="style.css" rel="stylesheet" />

	<!-- Bootstrap -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

	<!-- Custom Js -->
	<script src="main.js"></script>

	<!-- Vue 2 -->
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

	<!-- FullCalendar CSS & JS -->
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
</head>
<style>
	#calendar {
		max-width: 900px;
		margin: 40px auto;
	}

	.fc {
		padding: 6px;
	}
</style>

<body data-page="schedule">

	<div id="app">
		<h1>{{ msg }}</h1>
		<div id="calendar"></div>

		<!-- 底部導覽載入位置 -->
		<div id="bottomNav"></div>

		<!-- 新增行程 Modal -->
		<div class="modal fade" id="scheduleModal" tabindex="-1">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">新增行程</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<!-- Tabs -->
						<ul class="nav nav-tabs mb-3" id="Tabs" role="tablist">
							<li class="nav-item" role="presentation">
								<button class="nav-link active" id="schedule-tab" data-bs-toggle="tab"
									data-bs-target="#schedule" type="button" role="tab">事件內容</button>
							</li>
						</ul>

						<!-- Tab Content -->
						<div class="tab-content" id="scheduleTabsContent">
							<!-- 代訂品項 -->
							<div class="tab-pane fade show active" id="schedule" role="tabpanel"
								aria-labelledby="schedule-tab">
								<div class="p-4 bg-light rounded shadow-sm">
									<div class="container mt-4 mb-4" id="scheduleContent">
										<div class="mb-3">
											<label class="form-label"><span class="text-danger">*</span> 事件名稱</label>
											<div class="form-check form-check-inline">
												<input class="form-check-input" type="radio" name="eventType"
													value="new" checked onchange="toggleEvent()">
												<label class="form-check-label">新事件</label>
											</div>
											<div class="form-check form-check-inline">
												<input class="form-check-input" type="radio" name="eventType"
													value="old" onchange="toggleEvent()">
												<label class="form-check-label">舊事件</label>
											</div>
										</div>

										<div id="scheduleWrapper">
											<div class="row g-2 mb-2 schedule-row">
												<!-- 新事件 -->
												<div class="col-12 d-flex gap-2" id="newEvent">
													<input type="text" class="form-control scheduleName"
														name="newEvent[]" placeholder="請輸入新事件" required>
												</div>
												<!-- 舊事件 -->
												<div class="col-12 d-none gap-2" id="oldEvent">
													<select class="form-select scheduleNames"
														name="oldEvent[]"></select>
												</div>
											</div>
										</div>
									</div>
									<button class="btn btn-success w-100" id="addSchedule"
										onclick="addSchedule()">確認送出</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>

	new Vue({
		el: '#app',
		data: {
			msg: '',
			userId: 'test',
			schedules: { data: [] },
		},
		methods: {

			loadSchedules() {

				// var ym = this.getLastMonth();
				// ⬇ 取得 users/test/202503_schedules
				db.ref("users/" + this.userId + "/schedules").on("value", (snapshot) => {
					const raw = snapshot.val();

					let events = [];

					if (raw) {

						let parsed = JSON.parse(raw);

						let list = parsed.data || [];

						events = list.map(item => ({
							id: item.id,
							title: item.name + "：" + item.content,
							start: item.start,
							end: item.end
						}));
					}

					// console.log(events);

					events = this.adjustAllDayEndDates(events);

					this.renderCalendar(events);
				});
			},

			async getFirebaseData() {

				let schedules;

				const def = db.ref('users/' + this.userId + '/schedules');
				const data = await def.once("value");

				if (data.exists()) {
					schedules = JSON.parse(data.val());
					this.schedules = schedules;
				}
			},

			addEvent({ title, start, end, allDay }) {

				const def = db.ref('users/' + this.userId + '/schedules');

				var arr = title.split(/[:：]/);

				var nextId = this.schedules.data.reduce((maxId, item) => Math.max(maxId, item.id || 0), 0) + 1;

				var list = {
					id: nextId,
					name: arr[0],
					content: arr[1],
					start: start,
					end: end,
				};

				this.schedules.data.push(list);
				def.set(JSON.stringify(this.schedules));
			},

			delEvent(id) {

				const def = db.ref('users/' + this.userId + '/schedules');

				this.schedules.data = this.schedules.data.filter(item => item.id !== id);

				def.update({ schedules: JSON.stringify(this.schedules) });

			},

			renderCalendar(events) {
				let calEl = document.getElementById("calendar");
				calEl.innerHTML = ""; // 清除舊日曆

				let calendar = new FullCalendar.Calendar(calEl, {
					initialView: "dayGridMonth",
					locale: "zh-tw",
					events: events,
					height: "auto",
					editable: true,     // 允許拖曳 / resize
					selectable: true,   // 可拉區間新增
					dayMaxEvents: true,
					dateClick: async (info) => { // 點日期新增

						const title = prompt("輸入事件名稱(Ex: 事件名稱:事件內容)");
						if (!title) return;
						if (!/[:：]/.test(title)) { alert('請參照範例格式新增事件!!'); }

						calendar.addEvent({
							title,
							start: info.dateStr,
							allDay: true
						});

						await this.getFirebaseData();

						// TODO: 存 DB(Firebase database)
						this.addEvent({
							title: title,
							start: info.dateStr,
							end: info.dateStr,
							allDay: true
						});
					},

					select: async (info) => { // 拉區間新增

						const title = prompt("輸入事件名稱");
						if (!title) return;
						if (!/[:：]/.test(title)) { alert('請參照範例格式新增事件!!'); }

						calendar.addEvent({
							title,
							start: info.startStr,
							end: info.endStr,
							allDay: info.allDay
						});

						calendar.unselect();

						await this.getFirebaseData();

						// TODO: 存 DB
						this.addEvent({
							title: title,
							start: info.startStr,
							end: info.endStr,
							allDay: info.allDay
						});
					},

					eventClick: async (info) => { // 點擊事件（編輯 / 刪除）

						const action = confirm("按「確定」= 刪除\n按「取消」= 修改標題");

						if (action) {
							info.event.remove();
							// TODO: 刪除 DB

							await this.getFirebaseData();

							// console.log(info);
							this.delEvent(info.event.id);

						} else {

							const newTitle = prompt("修改事件名稱", info.event.title);

							if (newTitle) {
								info.event.setProp("title", newTitle);
								// TODO: 更新 DB
							}
						}
					},

					eventDrop(info) { // 拖曳事件（改日期）
						// info.event.start / info.event.end
						console.log("拖曳後", info.event);

						// API 失敗可回復
						// info.revert();
						// TODO: 更新 DB
					},

					eventResize(info) { // 拉長 / 縮短
						console.log("resize 後", info.event);
						// TODO: 更新 DB
					}
				});

				calendar.render();
			},

			dateClick(info) {
				// info.dateStr: '2025-03-27'
				calendar.addEvent({
					title: '新事件',
					start: info.dateStr,
					allDay: true
				});
			},

			// 自動調整 allDay 事件的 end 日期
			adjustAllDayEndDates(events) {
				return events.map(event => {
					if (event.end) {
						const endDate = new Date(event.end);
						endDate.setDate(endDate.getDate() + 1); // +1 天
						return {
							...event,
							end: endDate.toISOString().split('T')[0] // YYYY-MM-DD
						};
					}
					return event;
				});
			},

			//抓上個月(年月)
			getLastMonth() {
				const date = new Date(); // 取得當前日期
				date.setMonth(date.getMonth() - 1); // 設定為上個月

				// 格式化為 YYYYMM
				const year = date.getFullYear(); // 取得年份
				const month = (date.getMonth() + 1).toString().padStart(2, '0'); // 取得月份（補0）

				return `${year}${month}`;
			},
		},
		async mounted() {

			await liff.init({ liffId: '2007457926-5wAYNP0w' });

			if (!liff.isLoggedIn()) {
				liff.login();
				return;
			}

			this.profile = await liff.getProfile();
			this.userId = this.profile.userId;

			this.loadSchedules();
		}
	});
</script>

</html>